<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chartink Screener Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #4361ee;
      --secondary-color: #3f37c9;
      --background-color: #f8f9fa;
      --card-color: #ffffff;
      --text-color: #333333;
      --border-color: #e0e0e0;
      --success-color: #4caf50;
      --warning-color: #ff9800;
      --danger-color: #f44336;
    }
    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      margin: 0;
      padding: 20px;
      line-height: 1.6;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    h2 {
      color: var(--primary-color);
      text-align: center;
      margin-bottom: 30px;
      font-weight: 700;
    }
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .screener-selector {
      padding: 10px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background-color: var(--card-color);
      width: 300px;
      cursor: pointer;
    }
    .refresh-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.3s;
    }
    .refresh-btn:hover {
      background-color: var(--secondary-color);
    }
    .lucky-bulls-section {
      margin-bottom: 40px;
    }
    .lucky-bulls-card {
      background-color: var(--card-color);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 25px;
      margin-bottom: 30px;
    }
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid var(--primary-color);
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .no-results {
      text-align: center;
      padding: 30px;
      color: #666;
    }
    .lucky-bulls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .lucky-stock {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: relative;
    }
    .lucky-stock.halal {
      border-left: 4px solid var(--success-color);
      background: linear-gradient(135deg,rgb(17, 231, 35) 0%,rgb(51, 88, 52) 100%);
    }
    .stock-name {
      font-weight: 700;
      font-size: 18px;
      color: var(--primary-color);
      margin-bottom: 5px;
      display: flex;
      align-items: center;
    }
    .stock-count {
      font-size: 14px;
      color: #666;
    }
    .stock-screeners {
      margin-top: 10px;
      font-size: 14px;
    }
    .screener-badge {
      display: inline-block;
      background-color: rgba(67, 97, 238, 0.1);
      color: var(--primary-color);
      padding: 3px 8px;
      border-radius: 12px;
      margin-right: 5px;
      margin-bottom: 5px;
      font-size: 12px;
    }
    .halal-tick {
      color: var(--success-color);
      margin-left: 8px;
      font-weight: bold;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .halal-tick::before {
      content: "✓";
      display: inline-block;
      background-color: var(--success-color);
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      text-align: center;
      line-height: 20px;
      font-size: 14px;
      margin-right: 5px;
      box-shadow: 0 2px 4px rgba(228, 12, 12, 0.9);
    }
    .halal-label {
      background-color: rgba(76, 175, 80, 0.1);
      color: var(--success-color);
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
      margin-left: 8px;
    }
    
    /* Screener Table Styles */
    .screener-table-container {
      overflow-x: auto;
      margin-top: 20px;
      background-color: var(--card-color);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 20px;
    }
    .screener-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    .screener-table th, 
    .screener-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }
    .screener-table th {
      background-color: var(--primary-color);
      color: white;
      font-weight: 500;
      position: sticky;
      top: 0;
    }
    .screener-table tr:hover {
      background-color: rgba(67, 97, 238, 0.05);
    }
    .screener-name-cell {
      font-weight: 500;
      color: var(--primary-color);
      white-space: nowrap;
    }
    .date-header {
      white-space: nowrap;
      text-align: center !important;
    }
    .stock-cell {
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .stock-count {
      display: inline-block;
      min-width: 20px;
      text-align: center;
      font-weight: bold;
    }
    .positive {
      color: var(--success-color);
    }
    .negative {
      color: var(--danger-color);
    }
    .neutral {
      color: var(--warning-color);
    }
    .screener-table-controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      align-items: center;
    }
    .date-range-selector {
      display: flex;
      gap: 10px;
    }
    .date-range-btn {
      padding: 5px 10px;
      border-radius: 4px;
      border: 1px solid var(--border-color);
      background-color: var(--card-color);
      cursor: pointer;
    }
    .date-range-btn.active {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    .search-box {
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid var(--border-color);
      min-width: 250px;
    }
    .tooltip {
      position: relative;
      display: inline-block;
    }
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: #555;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Chartink Screener Dashboard</h2>

    <div class="dashboard-header">
      <select class="screener-selector" id="screener-selector">
        <option value="">Select a Screener</option>
        <option value="all" selected>All Screeners</option>
      </select>
      <button class="refresh-btn" id="refresh-screener">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
    </div>

    <div class="lucky-bulls-section">
      <h3>Lucky Bulls - Top Stocks in Multiple Screeners (Last 7 Days)</h3>
      <div class="lucky-bulls-card">
        <div class="loading" id="lucky-bulls-loading">
          <div class="spinner"></div>
          <p>Identifying Lucky Bulls...</p>
        </div>
        <div id="lucky-bulls-content"></div>
      </div>
    </div>

    <div id="dashboard-content">
      <div class="screener-table-container">
        <div class="screener-table-controls">
          <div class="date-range-selector">
            <button class="date-range-btn active" data-days="7">7 Days</button>
            <button class="date-range-btn" data-days="14">14 Days</button>
            <button class="date-range-btn" data-days="30">30 Days</button>
            <button class="date-range-btn" data-days="90">90 Days</button>
            <button class="date-range-btn" data-days="0">All</button>
          </div>
          <input type="text" class="search-box" id="screener-search" placeholder="Search screeners or stocks...">
        </div>
        <table class="screener-table" id="screener-data-table">
          <thead>
            <tr>
              <th>Screener Name</th>
              <!-- Dates will be inserted here by JavaScript -->
            </tr>
          </thead>
          <tbody id="screener-data-body">
            <!-- Data will be inserted here by JavaScript -->
          </tbody>
        </table>
      </div>
    </div>

    <div class="loading" id="global-loading">
      <div class="spinner"></div>
      <p>Loading screener data...</p>
    </div>
  </div>

  <script>
    let allScreenersData = [];
    let currentDateRange = 7;

    document.addEventListener('DOMContentLoaded', () => {
      loadAllScreenersForLuckyBulls();
      setupEventListeners();
    });

    function setupEventListeners() {
      // Screener selector change
      document.getElementById('screener-selector').addEventListener('change', function() {
        const id = this.value;
        if (id === 'all') {
          loadAllScreeners();
        } else if (id) {
          loadScreenerByCacheOrFetch(id);
        }
      });

      // Refresh button
      document.getElementById('refresh-screener').addEventListener('click', function() {
        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Refreshing...';
        
        const id = document.getElementById('screener-selector').value;
        if (id === 'all') {
          loadAllScreeners();
        } else if (id) {
          loadScreenerData(id);
        }
        
        setTimeout(() => {
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
        }, 1000);
      });

      // Date range buttons
      document.querySelectorAll('.date-range-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.date-range-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          currentDateRange = parseInt(this.dataset.days);
          updateScreenerTable();
        });
      });

      // Search box
      document.getElementById('screener-search').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('#screener-data-body tr');
        
        rows.forEach(row => {
          const screenerName = row.querySelector('.screener-name-cell').textContent.toLowerCase();
          let hasMatch = screenerName.includes(searchTerm);
          
          if (!hasMatch) {
            // Check stock cells for matches
            const stockCells = row.querySelectorAll('.stock-cell');
            stockCells.forEach(cell => {
              if (cell.textContent.toLowerCase().includes(searchTerm)) {
                hasMatch = true;
              }
            });
          }
          
          row.style.display = hasMatch ? '' : 'none';
        });
      });
    }

    function loadAllScreenersForLuckyBulls() {
      fetch('/fetch-all-screeners/')
        .then(res => res.json())
        .then(data => {
          allScreenersData = data;
          loadScreenerList(data);
          analyzeLuckyBulls(data);
          updateScreenerTable();
        })
        .catch(() => {
          analyzeLuckyBulls([]);
        });
    }

    function loadScreenerList(screeners) {
      const selector = document.getElementById('screener-selector');
      selector.innerHTML = `<option value="">Select a Screener</option><option value="all" selected>All Screeners</option>`;
      screeners.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.name;
        selector.appendChild(opt);
      });
    }

    function updateScreenerTable() {
  if (allScreenersData.length === 0) return;
  
  const tableHead = document.querySelector('#screener-data-table thead tr');
  const tableBody = document.getElementById('screener-data-body');
  
  // Clear existing data
  while (tableHead.children.length > 1) {
    tableHead.removeChild(tableHead.lastChild);
  }
  tableBody.innerHTML = '';
  
  // Get unique dates from all screeners within the date range
  const allDates = getAllDatesWithinRange();
  if (allDates.length === 0) {
    tableBody.innerHTML = `<tr><td colspan="${allDates.length + 1}" class="no-results">No data available for the selected date range</td></tr>`;
    return;
  }
  
  // Add date headers
  allDates.forEach(date => {
    const th = document.createElement('th');
    th.className = 'date-header';
    th.textContent = formatDateHeader(date);
    tableHead.appendChild(th);
  });
  
  // Add screener rows
  allScreenersData.forEach(screener => {
    const row = document.createElement('tr');
    
    // Screener name cell
    const nameCell = document.createElement('td');
    nameCell.className = 'screener-name-cell';
    nameCell.textContent = screener.name;
    row.appendChild(nameCell);
    
    // Add data for each date
    allDates.forEach(date => {
      const cell = document.createElement('td');
      cell.className = 'stock-cell';
      
      const dayData = findDayData(screener.data, date);
      if (dayData) {
        const stocks = dayData.Stocks.split(',').map(s => s.trim()).filter(s => s);
        const halalStocks = Object.entries(dayData.HalalStatus || {})
          .filter(([_, isHalal]) => isHalal)
          .map(([stock, _]) => stock);
        
        // Display stock symbols instead of count
        if (stocks.length > 0) {
          const displayedStocks = stocks.length > 3 
            ? `${stocks.slice(0, 3).join(', ')} +${stocks.length - 3} more` 
            : stocks.join(', ');
          
          cell.innerHTML = `
            <div class="tooltip">
              ${displayedStocks}
              ${halalStocks.length > 0 ? `<span class="halal-label">${halalStocks.length} Halal</span>` : ''}
              <span class="tooltiptext">${stocks.join(', ')}</span>
            </div>
          `;
        } else {
          cell.textContent = '-';
        }
        
        // Add color coding based on count (optional)
        if (stocks.length > 10) {
          cell.classList.add('positive');
        } else if (stocks.length < 5) {
          cell.classList.add('negative');
        } else {
          cell.classList.add('neutral');
        }
      } else {
        cell.textContent = '-';
      }
      
      row.appendChild(cell);
    });
    
    tableBody.appendChild(row);
  });
}
    
    function getAllDatesWithinRange() {
      const allDates = new Set();
      const cutoffDate = currentDateRange > 0 ? 
        new Date(Date.now() - currentDateRange * 24 * 60 * 60 * 1000) : 
        null;
      
      allScreenersData.forEach(screener => {
        if (screener.data) {
          screener.data.forEach(day => {
            const dayDate = new Date(day.Date);
            if (!cutoffDate || dayDate >= cutoffDate) {
              allDates.add(day.Date);
            }
          });
        }
      });
      
      // Convert to array and sort by date (newest first)
      return Array.from(allDates).sort((a, b) => new Date(b) - new Date(a));
    }
    
    function findDayData(screenerData, date) {
      if (!screenerData) return null;
      return screenerData.find(day => day.Date === date);
    }
    
    function formatDateHeader(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric',
        year: date.getFullYear() !== new Date().getFullYear() ? '2-digit' : undefined
      });
    }

    function analyzeLuckyBulls(allScreenerData) {
      const loading = document.getElementById('lucky-bulls-loading');
      const content = document.getElementById('lucky-bulls-content');

      loading.style.display = 'block';
      content.innerHTML = '';

      try {
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

        const stockMap = {};
        const halalStocks = new Set();

        allScreenerData.forEach(screener => {
          if (screener.data) {
            screener.data.forEach(day => {
              Object.entries(day.HalalStatus || {}).forEach(([stock, isHalal]) => {
                if (isHalal) halalStocks.add(stock);
              });

              const dayDate = new Date(day.Date);
              if (dayDate >= sevenDaysAgo) {
                const stocks = day.Stocks.split(',').map(s => s.trim()).filter(s => s);
                stocks.forEach(stock => {
                  if (!stockMap[stock]) {
                    stockMap[stock] = { count: 0, screeners: new Set() };
                  }
                  stockMap[stock].count++;
                  stockMap[stock].screeners.add(screener.name);
                });
              }
            });
          }
        });

        let luckyBulls = Object.entries(stockMap)
          .map(([stock, data]) => ({
            stock,
            count: data.count,
            screeners: Array.from(data.screeners),
            isHalal: halalStocks.has(stock)
          }))
          .filter(item => item.count >= 3) // Changed from 7 to 3 for more results
          .sort((a, b) => {
            if (a.isHalal && !b.isHalal) return -1;
            if (!a.isHalal && b.isHalal) return 1;
            return b.count - a.count;
          });

        if (luckyBulls.length === 0) {
          content.innerHTML = `<div class="no-results"><p>No Lucky Bulls found (appeared at least 3 times in last 7 days).</p></div>`;
        } else {
          let html = `<div class="lucky-bulls-stats"><p>Found ${luckyBulls.length} stocks (appeared ≥ 3 times, Halal on top):</p></div><div class="lucky-bulls-grid">`;
          luckyBulls.forEach(bull => {
            html += `<div class="lucky-stock ${bull.isHalal ? 'halal' : ''}">
              <div class="stock-name">${bull.stock}${bull.isHalal ? '<span class="halal-tick" title="Halal Stock"></span><span class="halal-label">Halal</span>' : ''}</div>
              <div class="stock-count">Appeared ${bull.count} times</div>
              <div class="stock-screeners">${bull.screeners.map(s => `<span class="screener-badge">${s}</span>`).join('')}</div>
            </div>`;
          });
          html += `</div>`;
          content.innerHTML = html;
        }
      } catch (error) {
        console.error('Error analyzing Lucky Bulls:', error);
        content.innerHTML = `<div class="no-results"><p>Failed to analyze Lucky Bulls. Please try again.</p></div>`;
      } finally {
        loading.style.display = 'none';
      }
    }
  </script>
</body>
</html>